{% extends "base.html" %}
{% load custom_filters %}


{% block content %}
  <h2>æ¡ˆä»¶åˆ—è¡¨</h2>

  <!-- æœå°‹èˆ‡ç¯©é¸è¡¨å–® -->
  <form method="GET" action="{% url 'case_list' %}">
    <input type="text" name="q" value="{{ query }}" placeholder="è¼¸å…¥æœå°‹é—œéµå­—">
    
    <label for="sort_order">æ’åºæ–¹å¼ï¼š</label>
    <select name="sort_order" id="sort_order">
        <option value="-created_at" {% if sort_order == "-created_at" %}selected{% endif %}>æœ€æ–°å„ªå…ˆ</option>
        <option value="created_at" {% if sort_order == "created_at" %}selected{% endif %}>æœ€èˆŠå„ªå…ˆ</option>
    </select>  

    <label for="department">éƒ¨é–€ï¼š</label>
    <select name="department">
        <option value="">å…¨éƒ¨</option>
        {% for dept in all_departments %}
            <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
        {% endfor %}
    </select>
    
    <label for="status">ç‹€æ…‹ï¼š</label>
    <select name="status">
        <option value="">å…¨éƒ¨</option>
        {% for s in all_statuses %}
            <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
    </select>

    <!-- é–‹å§‹æ—¥æœŸ -->
    <label>é–‹å§‹æ—¥æœŸï¼š</label>
    <select name="start_year">
        <option value="">å¹´</option>
        {% for year in years %}
            <option value="{{ year }}" {% if start_year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
    </select>
    <select name="start_month">
        <option value="">æœˆ</option>
        {% for month in months %}
            <option value="{{ month }}" {% if start_month == month|stringformat:"s" %}selected{% endif %}>{{ month }}</option>
        {% endfor %}
    </select>
    <select name="start_day">
        <option value="">æ—¥</option>
        {% for day in days %}
            <option value="{{ day }}" {% if start_day == day|stringformat:"s" %}selected{% endif %}>{{ day }}</option>
        {% endfor %}
    </select>

    <!-- çµæŸæ—¥æœŸ -->
    <label>çµæŸæ—¥æœŸï¼š</label>
    <select name="end_year">
        <option value="">å¹´</option>
        {% for year in years %}
            <option value="{{ year }}" {% if end_year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
    </select>
    <select name="end_month">
        <option value="">æœˆ</option>
        {% for month in months %}
            <option value="{{ month }}" {% if end_month == month|stringformat:"s" %}selected{% endif %}>{{ month }}</option>
        {% endfor %}
    </select>
    <select name="end_day">
        <option value="">æ—¥</option>
        {% for day in days %}
            <option value="{{ day }}" {% if end_day == day|stringformat:"s" %}selected{% endif %}>{{ day }}</option>
        {% endfor %}
    </select>

    <button type="submit">æœå°‹</button>

    <a href="{% url 'case_list' %}" onclick="return clearFilters();">æ¸…é™¤ç¯©é¸</a>
  </form>

  <script>
    function clearFilters() {
        window.location.href = "{% url 'case_list' %}";
        return false;
    }
  </script>

  <!-- æ¡ˆä»¶åˆ—è¡¨ -->
  <table border="1">
    <thead>
        <tr>
            <th>æ¡ˆä»¶è™Ÿç¢¼</th>
            <th>éƒ¨é–€</th>
            <th>é›»è·¯åœ–</th>
            <th>æ©Ÿå‹</th>
            <th>å®¢æˆ¶æ¡ˆè™Ÿ</th>
            <th>è»Ÿé«”ç‰ˆæœ¬</th>
            <th>ç‹€æ…‹</th>
            <th>æœå°‹åŒ¹é…</th>
            {% if user.is_authenticated %}<th>æ“ä½œ</th>{% endif %}
        </tr>
    </thead>
    <tbody>
        {% for case in cases %}
        <tr>
            <td><a href="{% url 'case_detail' case.id %}">{{ case.case_number }}</a></td>
            <td>{{ case.department }}</td>
            <td>{{ case.circuit_diagram }}</td>
            <td>{{ case.model_type }}</td>
            <td>{{ case.business_case_number }}</td>
            <td>{{ case.software_version }}</td>
            <td>{{ case.status }}</td>
            <td>
				{% with search_results|get_item:case.id as match_reasons %}
					{% if match_reasons %}
						{% for reason in match_reasons %}
							<div>{{ reason|safe }}</div>  <!-- ğŸ”¹ `|safe` è®“ HTML æ¨™ç±¤ç”Ÿæ•ˆ -->
						{% endfor %}
					{% else %}
						-
					{% endif %}
				{% endwith %}
			</td>

            {% if user.is_authenticated %}
            <td><a href="{% url 'edit_case' case.id %}">ç·¨è¼¯</a></td>
            {% endif %}
        </tr>
        {% empty %}
        <tr>
            <td colspan="9">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ¡ˆä»¶</td>
        </tr>
        {% endfor %}
    </tbody>
  </table>

  {% if user.is_authenticated %}
    <a href="{% url 'add_case' %}">æ–°å¢æ¡ˆä»¶</a>
  {% endif %}
{% endblock %}
